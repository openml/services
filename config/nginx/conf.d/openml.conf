# See https://dev.to/danielkun/nginx-everything-about-proxypass-2ona#let-nginx-start-even-when-not-all-upstream-hosts-are-available for reason of weird regexes:
# we want NGINX to go up even when some of the locations are not reachable, and we want the subpath to be given to the upstream.


server {
  listen 80;
  server_name openml.org;
#  return 301 https://openml.org$request_uri;
#}
#
#server {
#  listen 443 ssl;

#  server_name openml.org;
  resolver 127.0.0.11;
  client_max_body_size 64G;
  large_client_header_buffers 4 32k;

  ssl_certificate          /etc/nginx/ssl/live/openml.org/fullchain.pem;
  ssl_certificate_key      /etc/nginx/ssl/live/openml.org/privkey.pem;
  include                  /etc/nginx/ssl/options-ssl-nginx.conf;
  
  location ~ /es(?:\/(.*))?$ {
     include /etc/nginx/shared.conf; 
     set $upstream_es http://elasticsearch:9200;
     proxy_pass $upstream_es/$1$is_args;
  }

  location ~ /api_splits/(.*)$ {
     include /etc/nginx/shared.conf; 
     set $upstream_api http://php-api:80/api_splits;
     proxy_pass $upstream_api/$1$is_args;
  }

  location ~ /api(?:\/(.*))$ {
     include /etc/nginx/shared.conf; 
     set $upstream_api http://php-api:80/api;
     proxy_pass $upstream_api/$1$is_args;
  }

  location ~ /docs(?:\/(.*))$ {
     include /etc/nginx/shared.conf;
     set $upstream_docs https://openml.github.io/docs;
     proxy_pass $upstream_docs/$1$is_args;
  }

  location ~ /data(?:\/(.*))$ {
     include /etc/nginx/shared.conf;
     set $upstream_data http://php-api:80/data;
     proxy_pass $upstream_data/$1$is_args;
  }

  location ~ /datasets(/.*)?$ {
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 300;
      # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      chunked_transfer_encoding off;

      rewrite ^/datasets(/.*)?$ /datasets$1 break;
      proxy_pass http://minio:9000;
   }
  
  location ~ (?:\/(.*))?$ {
     include /etc/nginx/shared.conf; 
     set $upstream_f http://frontend:5000;
     proxy_pass $upstream_f/$1$is_args;
  }

}
